@model IEnumerable<Minutas.Models.Departamento>

@{
    Layout = "_LayoutAdmin";

}

<div class="content">
    <aside class="sidebar">
        <a id="apartado-minutas" href="/Admin/Minutas">Minutas</a>
        <a id="apartado-empleados" href="/Admin/Empleado">Empleados</a>
        <a id="apartado-departamentos" href="/Admin/Departamento">Departamentos</a>
        <a id="apartado-configuracion" href="#">Configuración</a>
        <a id="apartado-perfil" href="#">Perfil</a>
    </aside>

    <main>
        <button id="crearDeptoBtn">+ Crear Departamento</button>

        <table id="tablaDepto">
            <thead>
                <tr>
                    <th>Departamento</th>
                    <th>Jefe</th>
                    <th>Departamento Superior</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var dep in Model)
                {
                    <tr data-id="@dep.Id"
                        data-nombre="@dep.Nombre"
                        data-jefe="@dep.IdJefe?.ToString()"
                        data-superior="@dep.IdDeptSuperior?.ToString()">
                        <td>@dep.Nombre</td>
                        <td>@dep.IdJefe</td>
                        <td>@dep.IdDeptSuperior</td>
                        <td class="eliminarDep">🗑</td>
                        <td class="editarDep">🖉</td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- Modal Crear -->
        <div class="modal" id="modalCrearDepto" style="display:none;">
            <form id="formCrear">
                <h3>Crear Departamento</h3>
                <label>Nombre</label>
                <input type="text" name="Nombre"><br>
                <label>Jefe de Departamento</label>
                <select name="IdJefe">
                    @foreach (var jefe in ViewBag.Empleados)
                    {
                        <option value="@jefe.Id">@jefe.Nombre</option>
                    }
                </select><br>
                <label>Departamento Superior</label>
                <select name="IdDeptSuperior">
                    @foreach (var superior in ViewBag.Departamentos)
                    {
                        <option value="@superior.Id">@superior.Nombre</option>
                    }
                </select><br>
                <div class="buttons">
                    <input type="submit" value="Confirmar">
                    <input type="button" value="Cancelar" onclick="cerrarModal('modalCrearDepto')">
                </div>
            </form>
        </div>

        <!-- Modal Editar -->
        <div class="modal" id="modalEditarDepto" style="display:none;">
            <form id="formEditar">
                <input type="hidden" name="Id">
                <h3>Editar Departamento</h3>
                <label>Nombre</label>
                <input type="text" name="Nombre"><br>
                <label>Jefe de Departamento</label>
                <select name="IdJefe">
                    @foreach (var jefe in ViewBag.Empleados)
                    {
                        <option value="@jefe.Id">@jefe.Nombre</option>
                    }
                </select><br>
                <label>Departamento Superior</label>
                <select name="IdDeptSuperior">
                    @foreach (var superior in ViewBag.Departamentos)
                    {
                        <option value="@superior.Id">@superior.Nombre</option>
                    }
                </select><br>
                <div class="buttons">
                    <input type="submit" value="Confirmar">
                    <input type="button" value="Cancelar" onclick="cerrarModal('modalEditarDepto')">
                </div>
            </form>
        </div>

        <!-- Modal Eliminar -->
        <div class="modal" id="modalEliminarDepto" style="display:none;">
            <div>
                <p>¿Desea dar de baja este departamento?</p>
                <button id="confirmarEliminar">Sí</button>
                <button onclick="cerrarModal('modalEliminarDepto')">No</button>
            </div>
        </div>
    </main>
</div>

<script>
    function cerrarModal(id) {
        document.getElementById(id).style.display = "none";
    }

    document.getElementById("crearDeptoBtn").addEventListener("click", function () {
        document.getElementById("modalCrearDepto").style.display = "block";
    });

    document.querySelectorAll(".editarDep").forEach(btn => {
        btn.addEventListener("click", function () {
            const row = btn.closest("tr");
            const modal = document.getElementById("modalEditarDepto");
            modal.querySelector("input[name='Id']").value = row.dataset.id;
            modal.querySelector("input[name='Nombre']").value = row.dataset.nombre;
            modal.querySelector("select[name='IdJefe']").value = row.dataset.jefe;
            modal.querySelector("select[name='IdDeptSuperior']").value = row.dataset.superior;
            modal.style.display = "block";
        });
    });

    let idAEliminar = null;
    document.querySelectorAll(".eliminarDep").forEach(btn => {
        btn.addEventListener("click", function () {
            idAEliminar = btn.closest("tr").dataset.id;
            document.getElementById("modalEliminarDepto").style.display = "block";
        });
    });

    document.getElementById("confirmarEliminar").addEventListener("click", function () {
        fetch(`/Admin/Departamento/EliminarConfirmado/${idAEliminar}`, {
            method: "POST"
        }).then(response => {
            if (response.ok) location.reload();
        });
    });

    // Formulario de creación
    document.getElementById("formCrear").addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch("/Admin/Departamento/Agregar", {
            method: "POST",
            body: new URLSearchParams(formData)
        }).then(response => {
            if (response.ok) location.reload();
        });
    });

    // Formulario de edición
    document.getElementById("formEditar").addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch("/Admin/Departamento/Editar", {
            method: "POST",
            body: new URLSearchParams(formData)
        }).then(response => {
            if (response.ok) location.reload();
        });
    });
</script>





